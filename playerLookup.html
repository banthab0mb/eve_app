// Load static corp/alliance JSON
let alliances = [], corporations = [];

async function loadData() {
  alliances = await fetch("alliances.json").then(r => r.json());
  corporations = await fetch("corporations.json").then(r => r.json());
}

// Autocomplete for alliances/corps
function searchList(list, query) {
  query = query.toLowerCase();
  return list.filter(x =>
    x.name.toLowerCase().includes(query) ||
    x.ticker.toLowerCase().includes(query)
  ).slice(0, 10);
}

// Lookup character, corp, or alliance exact name via /universe/ids/
async function lookupName(name) {
  const res = await fetch("https://esi.evetech.net/latest/universe/ids/", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify([name])
  });
  if (!res.ok) return null;
  const ids = await res.json();

  let category, id;
  if (ids.characters) { category = "character"; id = ids.characters[0].id; }
  else if (ids.corporations) { category = "corporation"; id = ids.corporations[0].id; }
  else if (ids.alliances) { category = "alliance"; id = ids.alliances[0].id; }
  else return null;

  const details = await fetch(`https://esi.evetech.net/latest/${category}s/${id}/`).then(r => r.json());

  if (category === "character") {
    const corp = await fetch(`/corporations/${details.corporation_id}/`).then(r => r.json());
    const alliance = corp.alliance_id
      ? await fetch(`/alliances/${corp.alliance_id}/`).then(r => r.json())
      : null;
    return { category, details, corp, alliance };
  }

  return { category, details };
}

// Format output nicely
function formatOutput(result) {
  if (!result) return "No results found.";

  if (result.category === "character") {
    const c = result.details, corp = result.corp, al = result.alliance;
    return `Character: ${c.name} (ID: ${c.character_id})
Birthday: ${c.birthday}
Sec Status: ${c.security_status ?? "N/A"}

Corporation: ${corp.name} [${corp.ticker}]
Alliance: ${al ? `${al.name} [${al.ticker}]` : "None"}`;
  }

  if (result.category === "corporation") {
    const c = result.details;
    return `Corporation: ${c.name} [${c.ticker}] (ID: ${c.corporation_id})
Alliance ID: ${c.alliance_id ?? "None"}`;
  }

  if (result.category === "alliance") {
    const a = result.details;
    return `Alliance: ${a.name} [${a.ticker}] (ID: ${a.alliance_id})
Founded: ${a.date_founded}`;
  }
}

// DOM
const box = document.getElementById("searchBox");
const suggestions = document.getElementById("suggestions");
const output = document.getElementById("output");

box.addEventListener("input", () => {
  const q = box.value.trim();
  if (!q) {
    suggestions.innerHTML = "";
    return;
  }

  // Autocomplete only for corps/alliances
  const aResults = searchList(alliances, q);
  const cResults = searchList(corporations, q);

  suggestions.innerHTML = "";
  [...aResults, ...cResults].forEach(item => {
    const li = document.createElement("li");
    li.textContent = `${item.name} [${item.ticker}]`;
    li.onclick = () => {
      box.value = item.name;
      suggestions.innerHTML = "";
    };
    suggestions.appendChild(li);
  });
});

// Lookup on Enter (characters exact, or selected corp/alliance)
box.addEventListener("keypress", async e => {
  if (e.key === "Enter") {
    output.textContent = "Searching...";
    const name = box.value.trim();
    if (!name) return;

    try {
      const result = await lookupName(name);
      output.textContent = formatOutput(result);
    } catch (err) {
      output.textContent = "Error fetching data.";
      console.error(err);
    }
  }
});

// Initialize
loadData();